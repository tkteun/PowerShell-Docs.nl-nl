---
ms.date: 06/11/2020
keywords: powershell,cmdlet
title: WinRMSecurity
ms.openlocfilehash: ee7e5f2c9c9a863e29c9278c40703a05c1943246
ms.sourcegitcommit: fd223afa50092839c74d8d5fbba791869665455f
ms.translationtype: MT
ms.contentlocale: nl-NL
ms.lasthandoff: 06/25/2020
ms.locfileid: "85353835"
---
# <a name="powershell-remoting-security-considerations"></a><span data-ttu-id="0cbf9-103">Beveiligingsoverwegingen bij externe communicatie met PowerShell</span><span class="sxs-lookup"><span data-stu-id="0cbf9-103">PowerShell Remoting Security Considerations</span></span>

<span data-ttu-id="0cbf9-104">Externe communicatie van Power shell is de aanbevolen manier om Windows-systemen te beheren.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-104">PowerShell Remoting is the recommended way to manage Windows systems.</span></span> <span data-ttu-id="0cbf9-105">Externe communicatie van Power shell is standaard ingeschakeld in Windows Server 2012 R2.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-105">PowerShell Remoting is enabled by default in Windows Server 2012 R2.</span></span> <span data-ttu-id="0cbf9-106">Dit document bevat beveiligings problemen, aanbevelingen en aanbevolen procedures voor het gebruik van externe communicatie met Power shell.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-106">This document covers security concerns, recommendations, and best practices when using PowerShell Remoting.</span></span>

## <a name="what-is-powershell-remoting"></a><span data-ttu-id="0cbf9-107">Wat is externe communicatie van Power shell?</span><span class="sxs-lookup"><span data-stu-id="0cbf9-107">What is PowerShell Remoting?</span></span>

<span data-ttu-id="0cbf9-108">Externe communicatie van Power Shell maakt gebruik van [Windows Remote Management (WinRM)](/windows/win32/winrm/portal), de micro soft-implementatie van het protocol [Web Services for Management (WS-Management)](https://www.dmtf.org/sites/default/files/standards/documents/DSP0226_1.2.0.pdf) , waarmee gebruikers Power shell-opdrachten kunnen uitvoeren op externe computers.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-108">PowerShell Remoting uses [Windows Remote Management (WinRM)](/windows/win32/winrm/portal), which is the Microsoft implementation of the [Web Services for Management (WS-Management)](https://www.dmtf.org/sites/default/files/standards/documents/DSP0226_1.2.0.pdf) protocol, to allow users to run PowerShell commands on remote computers.</span></span> <span data-ttu-id="0cbf9-109">U kunt meer informatie vinden over het gebruik van externe toegang via Power shell bij het [uitvoeren van opdrachten op afstand](running-remote-commands.md).</span><span class="sxs-lookup"><span data-stu-id="0cbf9-109">You can find more information about using PowerShell Remoting at [Running Remote Commands](running-remote-commands.md).</span></span>

<span data-ttu-id="0cbf9-110">Externe communicatie met Power shell is niet hetzelfde als het gebruik van de para meter **ComputerName** van een cmdlet om deze uit te voeren op een externe computer, die gebruikmaakt van Remote Procedure Call (RPC) als onderliggend protocol.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-110">PowerShell Remoting is not the same as using the **ComputerName** parameter of a cmdlet to run it on a remote computer, which uses Remote Procedure Call (RPC) as its underlying protocol.</span></span>

## <a name="powershell-remoting-default-settings"></a><span data-ttu-id="0cbf9-111">Externe standaard instellingen voor Power shell</span><span class="sxs-lookup"><span data-stu-id="0cbf9-111">PowerShell Remoting default settings</span></span>

<span data-ttu-id="0cbf9-112">Externe communicatie van Power shell (en WinRM) luistert op de volgende poorten:</span><span class="sxs-lookup"><span data-stu-id="0cbf9-112">PowerShell Remoting (and WinRM) listen on the following ports:</span></span>

- <span data-ttu-id="0cbf9-113">HTTP: 5985</span><span class="sxs-lookup"><span data-stu-id="0cbf9-113">HTTP: 5985</span></span>
- <span data-ttu-id="0cbf9-114">HTTPS: 5986</span><span class="sxs-lookup"><span data-stu-id="0cbf9-114">HTTPS: 5986</span></span>

<span data-ttu-id="0cbf9-115">Externe communicatie van Power Shell staat standaard alleen verbindingen toe van leden van de groep Administrators.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-115">By default, PowerShell Remoting only allows connections from members of the Administrators group.</span></span>
<span data-ttu-id="0cbf9-116">Sessies worden gestart op basis van de context van de gebruiker, zodat alle toegangs beheer van besturings systemen die worden toegepast op afzonderlijke gebruikers en groepen, blijven gelden tijdens de verbinding via externe communicatie met Power shell.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-116">Sessions are launched under the user's context, so all operating system access controls applied to individual users and groups continue to apply to them while connected over PowerShell Remoting.</span></span>

<span data-ttu-id="0cbf9-117">In particuliere netwerken accepteert de standaard Windows Firewall regel voor externe communicatie van Power shell alle verbindingen.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-117">On private networks, the default Windows Firewall rule for PowerShell Remoting accepts all connections.</span></span> <span data-ttu-id="0cbf9-118">In open bare netwerken staat de standaard Windows Firewall regel externe verbindingen van Power shell alleen vanuit hetzelfde subnet toe.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-118">On public networks, the default Windows Firewall rule allows PowerShell Remoting connections only from within the same subnet.</span></span> <span data-ttu-id="0cbf9-119">U moet deze regel expliciet wijzigen om externe communicatie van Power shell te openen voor alle verbindingen op een openbaar netwerk.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-119">You have to explicitly change that rule to open PowerShell Remoting to all connections on a public network.</span></span>

> [!Warning]
> <span data-ttu-id="0cbf9-120">De firewall regel voor open bare netwerken is bedoeld om de computer te beschermen tegen mogelijk kwaad aardige externe Verbindings pogingen.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-120">The firewall rule for public networks is meant to protect the computer from potentially malicious external connection attempts.</span></span> <span data-ttu-id="0cbf9-121">Wees voorzichtig bij het verwijderen van deze regel.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-121">Use caution when removing this rule.</span></span>

## <a name="process-isolation"></a><span data-ttu-id="0cbf9-122">Proces isolatie</span><span class="sxs-lookup"><span data-stu-id="0cbf9-122">Process isolation</span></span>

<span data-ttu-id="0cbf9-123">Externe communicatie van Power Shell maakt gebruik van WinRM voor het communiceren tussen computers.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-123">PowerShell Remoting uses WinRM for communication between computers.</span></span> <span data-ttu-id="0cbf9-124">WinRM wordt uitgevoerd als een service onder het netwerk service account en geïsoleerde processen worden uitgevoerd als gebruikers accounts voor het hosten van Power shell-exemplaren.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-124">WinRM runs as a service under the Network Service account, and spawns isolated processes running as user accounts to host PowerShell instances.</span></span> <span data-ttu-id="0cbf9-125">Een instantie van Power shell die wordt uitgevoerd als één gebruiker heeft geen toegang tot een proces dat een exemplaar van Power shell uitvoert als een andere gebruiker.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-125">An instance of PowerShell running as one user has no access to a process running an instance of PowerShell as another user.</span></span>

## <a name="event-logs-generated-by-powershell-remoting"></a><span data-ttu-id="0cbf9-126">Gebeurtenis logboeken die zijn gegenereerd door externe communicatie met Power shell</span><span class="sxs-lookup"><span data-stu-id="0cbf9-126">Event logs generated by PowerShell Remoting</span></span>

<span data-ttu-id="0cbf9-127">FireEye heeft een goed overzicht gegeven van de gebeurtenis logboeken en andere beveiligings bewijzen die worden gegenereerd door externe communicatie sessies van Power shell, die beschikbaar zijn bij het [onderzoeken van Power shell-aanvallen](https://www.fireeye.com/content/dam/fireeye-www/global/en/solutions/pdfs/wp-lazanciyan-investigating-powershell-attacks.pdf).</span><span class="sxs-lookup"><span data-stu-id="0cbf9-127">FireEye has provided a good summary of the event logs and other security evidence generated by PowerShell Remoting sessions, available at [Investigating PowerShell Attacks](https://www.fireeye.com/content/dam/fireeye-www/global/en/solutions/pdfs/wp-lazanciyan-investigating-powershell-attacks.pdf).</span></span>

## <a name="encryption-and-transport-protocols"></a><span data-ttu-id="0cbf9-128">Versleutelings-en transport protocollen</span><span class="sxs-lookup"><span data-stu-id="0cbf9-128">Encryption and transport protocols</span></span>

<span data-ttu-id="0cbf9-129">Het is handig om de beveiliging van een externe Power shell-verbinding van twee perspectieven te overwegen: initiële verificatie en doorlopende communicatie.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-129">It is helpful to consider the security of a PowerShell Remoting connection from two perspectives: initial authentication, and ongoing communication.</span></span>

<span data-ttu-id="0cbf9-130">Ongeacht het transport protocol dat wordt gebruikt (HTTP of HTTPS), versleutelt WinRM altijd alle externe communicatie van Power shell na de eerste verificatie.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-130">Regardless of the transport protocol used (HTTP or HTTPS), WinRM always encrypts all PowerShell remoting communication after initial authentication.</span></span>

### <a name="initial-authentication"></a><span data-ttu-id="0cbf9-131">Initiële verificatie</span><span class="sxs-lookup"><span data-stu-id="0cbf9-131">Initial authentication</span></span>

<span data-ttu-id="0cbf9-132">Met verificatie wordt de identiteit van de client aan de server en de ideale server voor de-client bevestigd.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-132">Authentication confirms the identity of the client to the server - and ideally - the server to the client.</span></span>

<span data-ttu-id="0cbf9-133">Wanneer een client verbinding maakt met een domein server met behulp van de computer naam, is het standaard verificatie protocol [Kerberos](/windows/win32/secauthn/microsoft-kerberos).</span><span class="sxs-lookup"><span data-stu-id="0cbf9-133">When a client connects to a domain server using its computer name, the default authentication protocol is [Kerberos](/windows/win32/secauthn/microsoft-kerberos).</span></span> <span data-ttu-id="0cbf9-134">Kerberos garandeert zowel de identiteit van de gebruikers-id als de server zonder de herbruikbare referentie te verzenden.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-134">Kerberos guarantees both the user identity and server identity without sending any sort of reusable credential.</span></span>

<span data-ttu-id="0cbf9-135">Kerberos-verificatie is niet mogelijk wanneer een client verbinding maakt met een domein server met behulp van het IP-adres of verbinding maakt met een werkgroepserver.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-135">When a client connects to a domain server using its IP address, or connects to a workgroup server, Kerberos authentication is not possible.</span></span> <span data-ttu-id="0cbf9-136">In dat geval is externe communicatie van Power shell afhankelijk van het [NTLM-verificatie protocol](/windows/win32/secauthn/microsoft-ntlm).</span><span class="sxs-lookup"><span data-stu-id="0cbf9-136">In that case, PowerShell Remoting relies on the [NTLM authentication protocol](/windows/win32/secauthn/microsoft-ntlm).</span></span> <span data-ttu-id="0cbf9-137">Het NTLM-verificatie protocol garandeert de gebruikers identiteit zonder dat er een sortering van Delegeer bare-referenties wordt verzonden.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-137">The NTLM authentication protocol guarantees the user identity without sending any sort of delegable credential.</span></span> <span data-ttu-id="0cbf9-138">Als u de identiteit van de gebruiker wilt bewijzen, moet de client en server een sessie sleutel van het wacht woord van de gebruiker berekenen zonder dat het wacht woord zelf hoeft te worden uitgewisseld.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-138">To prove user identity, the NTLM protocol requires that both the client and server compute a session key from the user's password without ever exchanging the password itself.</span></span> <span data-ttu-id="0cbf9-139">De server weet doorgaans niet het wacht woord van de gebruiker, zodat deze communiceert met de domein controller, die het wacht woord van de gebruiker kent en de sessie sleutel voor de server berekent.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-139">The server typically does not know the user's password, so it communicates with the domain controller, which does know the user's password and calculates the session key for the server.</span></span>

<span data-ttu-id="0cbf9-140">Het NTLM-protocol garandeert echter niet de identiteit van de server.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-140">The NTLM protocol does not, however, guarantee server identity.</span></span> <span data-ttu-id="0cbf9-141">Net als bij alle protocollen die gebruikmaken van NTLM voor verificatie, kan een aanvaller met toegang tot het computer account van een computer die lid is van een domein, de domein controller aanroepen om een NTLM-sessie sleutel te berekenen en de server te imiteren.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-141">As with all protocols that use NTLM for authentication, an attacker with access to a domain-joined computer's machine account could invoke the domain controller to compute an NTLM session-key and thereby impersonate the server.</span></span>

<span data-ttu-id="0cbf9-142">Verificatie op basis van NTLM is standaard uitgeschakeld, maar kan worden toegestaan door SSL op de doel server te configureren of door de WinRM TrustedHosts-instelling op de client te configureren.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-142">NTLM-based authentication is disabled by default, but may be permitted by either configuring SSL on the target server, or by configuring the WinRM TrustedHosts setting on the client.</span></span>

#### <a name="using-ssl-certificates-to-validate-server-identity-during-ntlm-based-connections"></a><span data-ttu-id="0cbf9-143">SSL-certificaten gebruiken voor het valideren van de server identiteit tijdens op NTLM gebaseerde verbindingen</span><span class="sxs-lookup"><span data-stu-id="0cbf9-143">Using SSL certificates to validate server identity during NTLM-based connections</span></span>

<span data-ttu-id="0cbf9-144">Omdat het NTLM-verificatie protocol de identiteit van de doel server niet kan garanderen (alleen dat uw wacht woord al bekend is), kunt u doel servers configureren voor het gebruik van SSL voor externe communicatie met Power shell.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-144">Since the NTLM authentication protocol cannot ensure the identity of the target server (only that it already knows your password), you can configure target servers to use SSL for PowerShell Remoting.</span></span>
<span data-ttu-id="0cbf9-145">Als u een SSL-certificaat aan de doel server toewijst (indien dit wordt uitgegeven door een certificerings instantie die de client ook vertrouwt), schakelt u verificatie op basis van NTLM in die zowel de gebruikers-id als de identiteit van de server garandeert.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-145">Assigning a SSL certificate to the target server (if issued by a Certificate Authority that the client also trusts) enables NTLM-based authentication that guarantees both the user identity and server identity.</span></span>

#### <a name="ignoring-ntlm-based-server-identity-errors"></a><span data-ttu-id="0cbf9-146">Server identiteits fouten op basis van NTLM negeren</span><span class="sxs-lookup"><span data-stu-id="0cbf9-146">Ignoring NTLM-based server identity errors</span></span>

<span data-ttu-id="0cbf9-147">Als het implementeren van een SSL-certificaat op een server voor NTLM-verbindingen niet haalbaar is, kunt u de resulterende identiteits fouten onderdrukken door de server toe te voegen aan de lijst met WinRM **TrustedHosts** .</span><span class="sxs-lookup"><span data-stu-id="0cbf9-147">If deploying a SSL certificate to a server for NTLM connections is infeasible, you may suppress the resulting identity errors by adding the server to the WinRM **TrustedHosts** list.</span></span> <span data-ttu-id="0cbf9-148">Het toevoegen van een server naam aan de lijst met **TrustedHosts** mag niet worden beschouwd als een vorm van een verklaring van de betrouw baarheid van de hosts zelf, omdat het NTLM-verificatie protocol niet kan garanderen dat u verbinding maakt met de host waarmee u verbinding wilt maken.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-148">Please note that adding a server name to the **TrustedHosts** list should not be considered as any form of statement of the trustworthiness of the hosts themselves - as the NTLM authentication protocol cannot guarantee that you are in fact connecting to the host you are intending to connect to.</span></span> <span data-ttu-id="0cbf9-149">In plaats daarvan moet u de TrustedHosts-instelling beschouwen als de lijst met hosts waarvoor u de fout die is gegenereerd door de server identiteit niet kunt controleren.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-149">Instead, you should consider the TrustedHosts setting to be the list of hosts for which you wish to suppress the error generated by being unable to verify the server's identity.</span></span>

### <a name="ongoing-communication"></a><span data-ttu-id="0cbf9-150">Doorlopende communicatie</span><span class="sxs-lookup"><span data-stu-id="0cbf9-150">Ongoing Communication</span></span>

<span data-ttu-id="0cbf9-151">Zodra de initiële verificatie is voltooid, wordt de doorlopende communicatie door WinRM versleuteld.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-151">Once initial authentication is complete, the WinRM encrypts the ongoing communication.</span></span> <span data-ttu-id="0cbf9-152">Bij het maken van verbinding via HTTPS wordt het TLS-protocol gebruikt om te onderhandelen over de versleuteling die wordt gebruikt voor het transporteren van gegevens.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-152">When connecting over HTTPS, the TLS protocol is used to negotiate the encryption used to transport data.</span></span>
<span data-ttu-id="0cbf9-153">Wanneer u verbinding maakt via HTTP, wordt versleuteling op bericht niveau bepaald door het gebruikte initiële verificatie protocol.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-153">When connecting over HTTP, message-level encryption is determined by initial authentication protocol used.</span></span>

- <span data-ttu-id="0cbf9-154">Basis verificatie biedt geen versleuteling.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-154">Basic authentication provide no encryption.</span></span>
- <span data-ttu-id="0cbf9-155">NTLM-verificatie maakt gebruik van een RC4-versleuteling met een 128-bits sleutel.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-155">NTLM authentication uses an RC4 cipher with a 128-bit key.</span></span>
- <span data-ttu-id="0cbf9-156">Kerberos-verificatie versleuteling wordt bepaald door de `etype` in het TGS-ticket.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-156">Kerberos authentication encryption is determined by the `etype` in the TGS ticket.</span></span> <span data-ttu-id="0cbf9-157">Dit is AES-256 op moderne systemen.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-157">This is AES-256 on modern systems.</span></span>
- <span data-ttu-id="0cbf9-158">CredSSP-versleuteling wordt gebruikt voor de TLS-coderings suite die in de handshake is onderhandeld.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-158">CredSSP encryption is uses the TLS cipher suite that was negotiated in the handshake.</span></span>

## <a name="making-the-second-hop"></a><span data-ttu-id="0cbf9-159">De tweede hop maken</span><span class="sxs-lookup"><span data-stu-id="0cbf9-159">Making the second hop</span></span>

<span data-ttu-id="0cbf9-160">Power shell Remoting maakt standaard gebruik van Kerberos (indien beschikbaar) of NTLM voor authenticatie.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-160">By default, PowerShell Remoting uses Kerberos (if available) or NTLM for authentication.</span></span> <span data-ttu-id="0cbf9-161">Beide protocollen verifiëren aan de externe computer zonder referenties te verzenden.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-161">Both of these protocols authenticate to the remote machine without sending credentials to it.</span></span> <span data-ttu-id="0cbf9-162">Dit is de veiligste manier om te verifiëren, maar omdat de externe computer niet beschikt over de referenties van de gebruiker, heeft deze geen toegang tot andere computers en services namens de gebruiker.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-162">This is the most secure way to authenticate, but because the remote machine does not have the user's credentials, it cannot access other computers and services on the user's behalf.</span></span> <span data-ttu-id="0cbf9-163">Dit staat bekend als het ' probleem met de tweede hop '.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-163">This is known as the "second hop problem".</span></span>

<span data-ttu-id="0cbf9-164">Er zijn verschillende manieren om dit probleem te voor komen.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-164">There are several ways to avoid this problem.</span></span> <span data-ttu-id="0cbf9-165">Zie [de tweede hop in Power shell Remoting maken](PS-remoting-second-hop.md)voor beschrijvingen van deze methoden en de voor-en nadelen van elke methode.</span><span class="sxs-lookup"><span data-stu-id="0cbf9-165">For descriptions of these methods, and the pros and cons of each, see [Making the second hop in PowerShell Remoting](PS-remoting-second-hop.md).</span></span>

## <a name="references"></a><span data-ttu-id="0cbf9-166">Verwijzingen</span><span class="sxs-lookup"><span data-stu-id="0cbf9-166">References</span></span>

- [<span data-ttu-id="0cbf9-167">Windows Remote Management (WinRM)</span><span class="sxs-lookup"><span data-stu-id="0cbf9-167">Windows Remote Management (WinRM)</span></span>](/windows/win32/winrm/portal)
- [<span data-ttu-id="0cbf9-168">Webservicebeheer (WS-Management)</span><span class="sxs-lookup"><span data-stu-id="0cbf9-168">Web Services for Management (WS-Management)</span></span>](https://www.dmtf.org/sites/default/files/standards/documents/DSP0226_1.2.0.pdf)
- [<span data-ttu-id="0cbf9-169">2.2.9.1 versleutelde bericht typen</span><span class="sxs-lookup"><span data-stu-id="0cbf9-169">2.2.9.1 Encrypted Message Types</span></span>](/openspecs/windows_protocols/ms-wsmv/58421aa4-861a-4410-831a-c999f094cdb7)
- [<span data-ttu-id="0cbf9-170">Kerberos</span><span class="sxs-lookup"><span data-stu-id="0cbf9-170">Kerberos</span></span>](/windows/win32/secauthn/microsoft-kerberos)
- [<span data-ttu-id="0cbf9-171">NTLM-verificatie Protocol</span><span class="sxs-lookup"><span data-stu-id="0cbf9-171">NTLM authentication protocol</span></span>](/windows/win32/secauthn/microsoft-ntlm)
- [<span data-ttu-id="0cbf9-172">Power shell-aanvallen onderzoeken</span><span class="sxs-lookup"><span data-stu-id="0cbf9-172">Investigating PowerShell Attacks</span></span>](https://www.fireeye.com/content/dam/fireeye-www/global/en/solutions/pdfs/wp-lazanciyan-investigating-powershell-attacks.pdf)
